name: 'Function App Deploy'
on:
  workflow_call:
    inputs:
      environment:
        description: 'The environment to deploy to'
        required: true
        type: string

jobs:
  terraform:
    name: 'Terraform - ${{ inputs.environment }}'
    uses: ./.github/workflows/terraform-deploy.yml
    with:
      environment: ${{ inputs.environment }}
      tf_working_dir: './infrastructure/live/dev/import'
    secrets: inherit

  function_app:
    name: 'FunctionApp - ${{ inputs.environment }}'
    needs: [ terraform ]
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    env:
      function_app_name: ${{ fromJson(needs.terraform.outputs.tf_actions_output).import_function_app_name.value }}
      function_app_resource_group: ${{ fromJson(needs.terraform.outputs.tf_actions_output).import_function_app_resource_group_name.value }}
    steps:
      - uses: actions/download-artifact@v3
        with:
          name: import_function_app
          path: ./function_app

      - uses: Azure/login@v1
        with:
          creds: '{"clientId":"${{ secrets.ARM_CLIENT_ID }}","clientSecret":"${{ secrets.ARM_CLIENT_SECRET }}","subscriptionId":"${{ secrets.ARM_SUBSCRIPTION_ID }}","tenantId":"${{ secrets.ARM_TENANT_ID }}"}'
      - name: Get Publish Profile
        run: |
          echo "PUBLISH_PROFILE=$(az webapp deployment list-publishing-profiles -g '${{ env.function_app_resource_group }}' -n '${{ env.function_app_name }}' --xml)" >> $GITHUB_OUTPUT
        id: getPublishProfile

      - name: 'Deploy Function App to Azure'
        uses: Azure/functions-action@v1
        id: fa
        with:
          app-name: ${{ env.function_app_name }}
          package: './function_app'
          publish-profile: ${{ steps.getPublishProfile.outputs.PUBLISH_PROFILE }}

